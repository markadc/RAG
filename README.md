# RAG æ··åˆæ£€ç´¢ç³»ç»Ÿ

åŸºäº Elasticsearch å’Œ Milvus çš„æ··åˆæ£€ç´¢ç³»ç»Ÿï¼Œç»“åˆå…³é”®è¯åŒ¹é…å’Œè¯­ä¹‰ç›¸ä¼¼åº¦æ£€ç´¢ï¼Œæä¾›æ›´å‡†ç¡®çš„æœç´¢ç»“æœã€‚

## ğŸ“‹ é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„æ··åˆæ£€ç´¢ï¼ˆHybrid Searchï¼‰ç³»ç»Ÿï¼Œèåˆäº†ï¼š

- **Elasticsearch**ï¼šåŸºäº BM25 ç®—æ³•çš„å…³é”®è¯åŒ¹é…æ£€ç´¢
- **Milvus**ï¼šåŸºäºå‘é‡çš„è¯­ä¹‰ç›¸ä¼¼åº¦æ£€ç´¢
- **åŠ æƒèåˆ**ï¼šå¯è°ƒèŠ‚çš„æ£€ç´¢ç»“æœèåˆç­–ç•¥

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- ğŸ” **åŒæ¨¡æ£€ç´¢**ï¼šåŒæ—¶æ”¯æŒå…³é”®è¯åŒ¹é…å’Œè¯­ä¹‰æœç´¢
- âš–ï¸ **çµæ´»èåˆ**ï¼šå¯è°ƒèŠ‚ alpha å‚æ•°æ§åˆ¶ä¸¤ç§æ£€ç´¢æ–¹å¼çš„æƒé‡
- ğŸ“Š **å¯è§†åŒ–ç»“æœ**ï¼šä½¿ç”¨ Rich åº“ç¾åŒ–è¾“å‡ºï¼Œæ¸…æ™°å±•ç¤ºæ£€ç´¢ç»“æœ
- ğŸš€ **é«˜æ€§èƒ½**ï¼šElasticsearch æä¾›å¿«é€Ÿå…³é”®è¯åŒ¹é…ï¼ŒMilvus æä¾›é«˜æ•ˆå‘é‡æ£€ç´¢
- ğŸ¯ **å®æ—¶å‘é‡åŒ–**ï¼šä½¿ç”¨ Ollama bge-m3 æ¨¡å‹è¿›è¡Œæ–‡æœ¬å‘é‡åŒ–

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **Python 3.10+**
- **Elasticsearch 8.x**ï¼šå…¨æ–‡æ£€ç´¢å¼•æ“
- **Milvus 2.x**ï¼šå‘é‡æ•°æ®åº“
- **Ollama**ï¼šæœ¬åœ°éƒ¨ç½²çš„ embedding æ¨¡å‹ï¼ˆbge-m3ï¼‰
- **Rich**ï¼šå‘½ä»¤è¡Œè¾“å‡ºç¾åŒ–
- **tqdm**ï¼šè¿›åº¦æ¡æ˜¾ç¤º

## ğŸ“¦ å®‰è£…

### 1. ç¯å¢ƒè¦æ±‚

- Python 3.10 æˆ–æ›´é«˜ç‰ˆæœ¬
- Elasticsearchï¼ˆè¿è¡Œåœ¨ localhost:9200ï¼‰
- Milvusï¼ˆè¿è¡Œåœ¨ localhost:19530ï¼‰
- Ollamaï¼ˆå®‰è£… bge-m3 æ¨¡å‹ï¼‰

### 2. å®‰è£…ä¾èµ–

```bash
pip install elasticsearch elasticsearch-dsl
pip install pymilvus
pip install ollama
pip install rich tqdm
```

### 3. å¯åŠ¨æœåŠ¡

**Elasticsearch**

```bash
# Docker æ–¹å¼
docker run -d --name elasticsearch \
  -p 9200:9200 \
  -e "discovery.type=single-node" \
  -e "xpack.security.enabled=true" \
  -e "ELASTIC_PASSWORD=your_password" \
  docker.elastic.co/elasticsearch/elasticsearch:8.11.0
```

**Milvus**

```bash
# Docker æ–¹å¼
docker run -d --name milvus \
  -p 19530:19530 \
  milvusdb/milvus:latest
```

**Ollama + bge-m3**

```bash
# å®‰è£… Ollama
curl -fsSL https://ollama.com/install.sh | sh

# æ‹‰å– bge-m3 æ¨¡å‹
ollama pull bge-m3
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é…ç½®è¿æ¥ä¿¡æ¯

ç¼–è¾‘ `utils/es_cli.py` å’Œ `utils/milvus_cli.py`ï¼Œé…ç½®ä½ çš„è¿æ¥ä¿¡æ¯ã€‚

### 2. ä¿®æ”¹ç´¢å¼•åç§°

ç¼–è¾‘ `hybrid/es_mvs.py`ï¼Œä¿®æ”¹å¸¸é‡ï¼š

```python
ES_INDEX = "your_index_name"
MILVUS_COLLECTION = "your_collection_name"
```

### 3. åˆå§‹åŒ–æ•°æ®

ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ï¼Œéœ€è¦åˆå§‹åŒ–æ•°æ®ï¼š

```python
# åœ¨ es_mvs.py ä¸­
if __name__ == "__main__":
    setup_data()    # åˆå§‹åŒ–æ•°æ®ï¼ˆä»…ç¬¬ä¸€æ¬¡è¿è¡Œï¼‰
    demo_search()   # æ‰§è¡Œæ£€ç´¢æ¼”ç¤º
```

```bash
python hybrid/es_mvs.py
```

### 4. æ‰§è¡Œæ£€ç´¢

åˆå§‹åŒ–å®Œæˆåï¼Œæ³¨é‡Šæ‰ `setup_data()`ï¼š

```python
if __name__ == "__main__":
    # setup_data()  # å·²åˆå§‹åŒ–ï¼Œæ³¨é‡Šæ‰
    demo_search()
```

å†æ¬¡è¿è¡Œå³å¯æµ‹è¯•æ£€ç´¢åŠŸèƒ½ã€‚

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
RAG/
â”œâ”€â”€ hybrid/
â”‚   â””â”€â”€ es_mvs.py          # æ··åˆæ£€ç´¢ä¸»ç¨‹åº
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ es_cli.py          # Elasticsearch è¿æ¥å·¥å…·
â”‚   â”œâ”€â”€ milvus_cli.py      # Milvus è¿æ¥å·¥å…·
â”‚   â””â”€â”€ embedding.py       # æ–‡æœ¬å‘é‡åŒ–å·¥å…·
â”œâ”€â”€ .gitignore
â””â”€â”€ README.md
```

## ğŸ”§ é…ç½®è¯´æ˜

### Alpha å‚æ•°

æ§åˆ¶ Elasticsearch å’Œ Milvus çš„æƒé‡ï¼š

- `alpha = 1.0`ï¼šå®Œå…¨ä¾èµ– Elasticsearchï¼ˆå…³é”®è¯åŒ¹é…ï¼‰
- `alpha = 0.5`ï¼šå‡è¡¡ä½¿ç”¨ä¸¤ç§æ£€ç´¢æ–¹å¼
- `alpha = 0.0`ï¼šå®Œå…¨ä¾èµ– Milvusï¼ˆè¯­ä¹‰ç›¸ä¼¼åº¦ï¼‰

### ä¿®æ”¹æŸ¥è¯¢

åœ¨ `demo_search()` å‡½æ•°ä¸­ä¿®æ”¹æµ‹è¯•æŸ¥è¯¢ï¼š

```python
test_queries = [
    ("ä½ çš„æŸ¥è¯¢", 5, 0.5),  # (æŸ¥è¯¢æ–‡æœ¬, è¿”å›æ•°é‡, alphaå€¼)
    ("å¦ä¸€ä¸ªæŸ¥è¯¢", 3, 0.8),
]
```

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹è¾“å‡º

```
================================================================================
Elasticsearchã€Milvus æ··åˆæ£€ç´¢
================================================================================

ğŸ”— è¿æ¥åˆ° Elasticsearch...
âœ… Elasticsearch è¿æ¥æˆåŠŸ

ğŸ”— è¿æ¥åˆ° Milvus...
âœ… Milvus è¿æ¥æˆåŠŸ

================================================================================
ğŸ“ æµ‹è¯•æŸ¥è¯¢ 1/3
================================================================================
ğŸ” æŸ¥è¯¢: èƒ¸ç—›å¿ƒè‚Œæ¢—æ­»
================================================================================

1ï¸âƒ£  ä» Elasticsearch æ£€ç´¢...
   æ‰¾åˆ° 5 æ¡ç»“æœ

2ï¸âƒ£  ä» Milvus æ£€ç´¢...
   æ‰¾åˆ° 5 æ¡ç»“æœ

3ï¸âƒ£  èåˆæ£€ç´¢ç»“æœ...

================================================================================
ğŸ”¥ Hybrid Search Results (ES + Milvus Weighted Fusion)
================================================================================
â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ Rank â”ƒ  ID   â”ƒ Text                       â”ƒ ES Score â”ƒ Milvus Score â”ƒ Final Score â”ƒ   Source   â”ƒ
â”¡â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â”â”â”©
â”‚  1   â”‚   1   â”‚ Patient with chest pain... â”‚  1.0000  â”‚    1.0000    â”‚   1.0000    â”‚ ES, Milvus â”‚
â”‚  2   â”‚  11   â”‚ Patient with heart fail... â”‚  0.2770  â”‚    0.3622    â”‚   0.3196    â”‚ ES, Milvus â”‚
â”‚  3   â”‚   5   â”‚ Patient with gastric ca... â”‚  0.0000  â”‚    0.1684    â”‚   0.0842    â”‚   Milvus   â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. æ•°æ®åˆå§‹åŒ–

```python
setup_data()  # åˆ›å»ºç´¢å¼•ã€é›†åˆå¹¶æ’å…¥æ•°æ®
```

### 2. æ··åˆæ£€ç´¢

```python
results, es_results, milvus_results = hybrid_search(
    es_client=es_client,
    milvus_collection=milvus_collection,
    query="ä½ çš„æŸ¥è¯¢",
    top_k=5,
    alpha=0.5
)
```

### 3. ç»“æœå±•ç¤º

```python
display_results(results, es_results, milvus_results)
```

## ğŸ” å·¥ä½œåŸç†

1. **å…³é”®è¯æ£€ç´¢**ï¼šElasticsearch ä½¿ç”¨ BM25 ç®—æ³•è¿›è¡Œå…³é”®è¯åŒ¹é…
2. **è¯­ä¹‰æ£€ç´¢**ï¼šå°†æŸ¥è¯¢æ–‡æœ¬å‘é‡åŒ–ï¼Œåœ¨ Milvus ä¸­è¿›è¡Œä½™å¼¦ç›¸ä¼¼åº¦æœç´¢
3. **åˆ†æ•°å½’ä¸€åŒ–**ï¼šå°†ä¸¤ç§æ£€ç´¢çš„åˆ†æ•°å½’ä¸€åŒ–åˆ° [0, 1] åŒºé—´
4. **åŠ æƒèåˆ**ï¼š`final_score = alpha * es_score + (1-alpha) * milvus_score`
5. **ç»“æœæ’åº**ï¼šæŒ‰èåˆåˆ†æ•°é™åºè¿”å› top-k ç»“æœ

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡è¿è¡Œ**ï¼šå¿…é¡»å…ˆæ‰§è¡Œ `setup_data()` åˆå§‹åŒ–æ•°æ®
2. **é‡å¤åˆå§‹åŒ–**ï¼šæ¯æ¬¡è¿è¡Œ `setup_data()` ä¼šåˆ é™¤æ—§æ•°æ®å¹¶é‡æ–°åˆ›å»º
3. **å‘é‡åŒ–è€—æ—¶**ï¼šé¦–æ¬¡æ’å…¥æ•°æ®æ—¶éœ€è¦ç”Ÿæˆ embeddingï¼Œä¼šæ¯”è¾ƒæ…¢
4. **æ¨¡å‹é€‰æ‹©**ï¼šé»˜è®¤ä½¿ç”¨ `bge-m3` æ¨¡å‹ï¼Œå¯åœ¨ `utils/embedding.py` ä¸­ä¿®æ”¹

## ğŸ“ è‡ªå®šä¹‰æ•°æ®

ä¿®æ”¹ `generate_medical_cases()` å‡½æ•°æ·»åŠ ä½ çš„æ•°æ®ï¼š

```python
def generate_medical_cases():
    medical_cases = [
        {
            "id": 1,
            "text": "ä½ çš„æ–‡æœ¬å†…å®¹",
        },
        # æ·»åŠ æ›´å¤šæ•°æ®...
    ]
    return medical_cases
```

## ğŸ› å¸¸è§é—®é¢˜

**Q: è¿æ¥ Elasticsearch/Milvus å¤±è´¥ï¼Ÿ**  
A: æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œç«¯å£æ˜¯å¦æ­£ç¡®ï¼Œè®¤è¯ä¿¡æ¯æ˜¯å¦é…ç½®ã€‚

**Q: å‘é‡åŒ–é€Ÿåº¦æ…¢ï¼Ÿ**  
A: bge-m3 æ¨¡å‹è¾ƒå¤§ï¼Œé¦–æ¬¡åŠ è½½ä¼šæ…¢ä¸€äº›ã€‚å¯ä»¥è€ƒè™‘ä½¿ç”¨æ›´å°çš„æ¨¡å‹æˆ– GPU åŠ é€Ÿã€‚

**Q: æœç´¢ç»“æœä¸å‡†ç¡®ï¼Ÿ**  
A: è°ƒæ•´ alpha å‚æ•°ï¼Œæˆ–è€…å¢åŠ è®­ç»ƒæ•°æ®é‡ã€‚

## ğŸ“„ License

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æäº¤ Issueã€‚
